<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grist Map Widget</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    :root{
      --brand:#4a6fa5;
      --bg:#f8f9fa;
      --fg:#2c3e50;
      --muted:#6c757d;
      --border:#e1e5e9;
      --ring:rgba(74,111,165,.12);
      --card:#fff;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:12px;
      --sidebar-w:320px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:#333;
      line-height:1.45;
      overflow:hidden;
    }

    /* Toggle */
    .sidebar-toggle{
      position:fixed; inset:16px auto auto 16px;
      z-index:1001;
      background:#fff; border:1px solid var(--border);
      border-radius:10px; width:40px;height:40px; display:grid; place-items:center;
      box-shadow:var(--shadow);
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .sidebar-toggle:hover{background:#f3f5f7; box-shadow:0 10px 26px rgba(0,0,0,.12)}
    .hamburger{width:18px;height:2px;background:#111;border-radius:2px;position:relative}
    .hamburger::before,.hamburger::after{content:"";position:absolute;left:0;width:18px;height:2px;background:#111;border-radius:2px;transition:transform .3s ease,opacity .3s ease}
    .hamburger::before{transform:translateY(-6px)}
    .hamburger::after{transform:translateY(6px)}
    .sidebar-toggle.active .hamburger{background:transparent}
    .sidebar-toggle.active .hamburger::before{transform:rotate(45deg)}
    .sidebar-toggle.active .hamburger::after{transform:rotate(-45deg)}

    /* Sidebar */
    .property-sidebar{
      position:fixed; inset:0 auto 0 0;
      width:var(--sidebar-w); max-width:100%;
      background:var(--card);
      border-right:1px solid var(--border);
      transform:translateX(-100%);
      transition:transform .35s cubic-bezier(.22,1,.36,1);
      z-index:1000; display:flex; flex-direction:column;
      box-shadow:2px 0 30px rgba(0,0,0,.08);
    }
    .property-sidebar.open{transform:translateX(0)}

    .sidebar-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; background:linear-gradient(120deg, var(--brand), #6e90c1);
      color:#fff;
    }
    .header-content{display:flex; align-items:center; gap:10px}
    .header-content h2{font-size:16px;font-weight:700}
    .property-count{
      background:rgba(255,255,255,.25); padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700;
    }
    .sidebar-toggle-btn{
      background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25);
      width:30px;height:30px; border-radius:999px; color:#fff; display:grid; place-items:center; cursor:pointer;
    }
    .sidebar-toggle-btn:hover{background:rgba(255,255,255,.25)}

    .sidebar-content{
      flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:12px;
      scrollbar-width:thin; scrollbar-color:#cfd4da transparent;
    }
    .sidebar-content::-webkit-scrollbar{width:8px}
    .sidebar-content::-webkit-scrollbar-thumb{background:#cfd4da;border-radius:8px}

    .search-container{position:relative}
    .sidebar-search{
      width:100%; padding:12px 40px 12px 14px; border:1px solid var(--border); border-radius:10px;
      background:#fff; font-weight:500; font-size:14px; outline:none; transition:box-shadow .2s ease, border-color .2s ease;
    }
    .sidebar-search:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}
    .clear-search{
      position:absolute; right:6px; top:50%; transform:translateY(-50%);
      width:28px;height:28px; border-radius:8px; border:1px solid var(--border); background:#fff; color:#111;
      display:none; align-items:center; justify-content:center; cursor:pointer;
    }
    .clear-search:hover{background:#f8fafc}

    .property-list{display:flex; flex-direction:column; gap:10px}
    .property-item{
      display:flex; gap:12px; align-items:flex-start; padding:12px;
      border:1px solid var(--border); border-radius:10px; cursor:pointer; background:#fff;
      transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .property-item:hover{transform:translateY(-2px); box-shadow:var(--shadow); border-color:#cfd5dc}
    .property-item.active{border-color:var(--brand); background:#f6f9ff}
    .property-thumbnail{width:54px;height:54px; border-radius:8px; overflow:hidden; border:1px solid var(--border); display:grid; place-items:center; background:#f3f5f7; flex-shrink:0}
    .property-thumbnail img{width:100%; height:100%; object-fit:cover}
    .property-thumbnail span{font-size:11px; color:var(--muted)}
    .property-info{flex:1; min-width:0}
    .property-info h4{font-size:15px; font-weight:700; color:var(--fg); margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .property-type{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:700; color:#334155; background:#eef2f7; margin-bottom:4px}
    .property-address{font-size:12px; color:#475569; font-weight:600; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .property-id{font-size:11px; color:var(--muted); font-weight:600}

    .property-details{background:#fff; border:1px solid var(--border); border-radius:12px; overflow:hidden; display:none}
    .property-details.active{display:block}
    .details-header{padding:12px 14px; background:#f6f7f9; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between}
    .details-header h3{font-size:15px; font-weight:800; color:var(--fg)}
    .close-details{border:none; background:#fff; border:1px solid var(--border); width:30px;height:30px; border-radius:8px; font-size:18px; color:#111; cursor:pointer}
    .close-details:hover{background:#f4f6f8}

    .details-content{padding:12px}
    .details-view-image{width:80px; height:60px; border-radius:8px; border:1px solid var(--border); background:#f4f6f8; overflow:hidden; display:grid; place-items:center}
    .details-view-image img{width:100%; height:100%; object-fit:cover}
    .details-view-info h3{font-size:18px; font-weight:800; color:var(--fg); margin-bottom:6px}
    .details-view-type{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eef2f7; color:#334155; font-size:12px; font-weight:700; margin-bottom:6px}
    .details-view-address{font-size:13px; color:#475569; font-weight:700; margin-bottom:6px}
    .details-view-ids{display:flex; gap:14px; font-size:12px; color:#64748b; font-weight:700}

    /* Phones */
    .phone-section{background:#fff; border:1px solid var(--border); border-radius:10px; overflow:hidden; margin-top:10px}
    .phone-section h4{font-size:13px; font-weight:800; color:var(--fg); padding:10px 12px; background:#f6f7f9; border-bottom:1px solid #eef0f2}
    .phone-item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid #eef0f2}
    .phone-item:last-child{border-bottom:none}
    .phone-info{display:flex; flex-direction:column; gap:3px}
    .phone-number{font-size:15px; font-weight:800; color:var(--fg)}
    .phone-status{font-size:11px; color:#2e7d32; font-weight:800; letter-spacing:.4px}
    .phone-actions{display:flex; gap:8px}
    .action-btn{width:34px;height:34px; border:1px solid var(--border); border-radius:8px; background:#fff; display:grid; place-items:center; cursor:pointer}
    .action-btn:hover{box-shadow:var(--shadow); transform:translateY(-1px)}
    .action-btn a{text-decoration:none; color:inherit}

    /* Map */
    #map{width:100%; height:100vh; transition:margin-left .35s cubic-bezier(.22,1,.36,1)}
    #map.sidebar-open{margin-left:var(--sidebar-w)}

    /* Loading */
    .loading-overlay{position:fixed; inset:0; background:rgba(255,255,255,.92); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; z-index:2000}
    .loading-spinner{width:42px;height:42px; border:4px solid #e9edf1; border-top:4px solid var(--brand); border-radius:999px; animation:spin 1s linear infinite}
    .loading-text{font-size:15px; color:#334155; font-weight:700}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Overlay */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:999; opacity:0; visibility:hidden; transition:.3s ease}
    .overlay.active{opacity:1; visibility:visible}

    /* Popup card */
    .leaflet-popup-content-wrapper{background:transparent; box-shadow:none}
    .leaflet-popup-tip{background:transparent; box-shadow:none}
    .leaflet-popup-content{margin:0}
    .card{position:relative; width:240px; height:140px; border-radius:10px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.25); background:transparent}
    .card img{width:100%; height:100%; object-fit:cover; display:block}
    .card-content{position:absolute; inset:auto 0 0 0; background:linear-gradient(transparent, rgba(0,0,0,.85)); color:#fff; padding:12px}
    .card-content .title{font-size:14px; font-weight:800; margin-bottom:4px; line-height:1.2}
    .card-content .location{font-size:12px; opacity:.95; display:flex; align-items:center; gap:6px; cursor:pointer}
    .card-content .location svg{width:14px; height:14px}

    /* Marker clusters */
    .marker-cluster{background-clip:padding-box; border-radius:50%}
    .marker-cluster div{
      width:34px;height:34px;margin-left:3px;margin-top:3px; text-align:center; border-radius:50%;
      font:600 12px/34px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#111;
      background:#fff; border:2px solid rgba(0,0,0,.08)
    }
    .marker-cluster-small{background-color:rgba(181,226,140,0.6)}
    .marker-cluster-small div{background-color:rgba(110,204,57,0.6)}
    .marker-cluster-medium{background-color:rgba(241,211,87,0.6)}
    .marker-cluster-medium div{background-color:rgba(240,194,12,0.6)}
    .marker-cluster-large{background-color:rgba(253,156,115,0.6)}
    .marker-cluster-large div{background-color:rgba(241,128,23,0.6)}

    /* Special cluster coloring for classifications */
    .marker-cluster-Not_Interested_DNC{background-color:rgba(232,63,61,.6)!important}
    .marker-cluster-IPA{background-color:rgba(177,88,240,.6)!important}
    .marker-cluster-Eric{background-color:rgba(255,159,64,.6)!important}
    .marker-cluster-Broker_Eh{background-color:rgba(159,160,165,.6)!important}
    .marker-cluster-Never{background-color:rgba(54,162,235,.6)!important}
    .marker-cluster-Call_Relationship{background-color:rgba(255,205,86,.6)!important}
    .marker-cluster-Contact{background-color:rgba(97,225,88,.6)!important}
    .marker-cluster-Call_Again{background-color:rgba(240,189,69,.6)!important}

    /* Responsive */
    @media (max-width: 768px){
      :root{--sidebar-w:280px}
      #map.sidebar-open{margin-left:0}
      .property-sidebar.open ~ .overlay{opacity:1; visibility:visible}
      .sidebar-toggle{inset:12px auto auto 12px}
      .card{width:220px;height:130px}
    }
    @media (max-width:480px){
      :root{--sidebar-w:100%}
    }
  </style>
</head>
<body>

  <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle Sidebar">
    <span class="hamburger"></span>
  </button>

  <div id="map" role="application" aria-label="Map"></div>

  <div id="loading-indicator" class="loading-overlay" aria-live="polite" aria-busy="true">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">Loading map data...</div>
  </div>

  <div id="sidebar" class="property-sidebar" aria-hidden="true" aria-label="Property sidebar">
    <div class="sidebar-header">
      <div class="header-content">
        <h2>Properties</h2>
        <span class="property-count" id="propertyCount">0</span>
      </div>
      <button id="closeSidebar" class="sidebar-toggle-btn" title="Collapse Sidebar" aria-label="Close sidebar">×</button>
    </div>

    <div class="sidebar-content">
      <div class="search-container">
        <input type="text" id="sidebar-search" placeholder="Search by owner, address, ID..." class="sidebar-search" aria-label="Search properties">
        <button class="clear-search" id="clear-search" title="Clear search" aria-label="Clear search">×</button>
      </div>

      <div class="property-list" id="property-list"></div>

      <div class="property-details" id="property-details" aria-live="polite">
        <div class="details-header">
          <h3>Property Details</h3>
          <button class="close-details" id="close-details" aria-label="Close details">×</button>
        </div>
        <div class="details-content" id="details-content"></div>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch@3.0.0/dist/geosearch.umd.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // Utils
    function columnarToRowFormat(columnarData) {
      if (!columnarData || !columnarData.id) return [];
      const rows = [];
      for (let i = 0; i < columnarData.id.length; i++) {
        const row = { id: columnarData.id[i], fields: {} };
        for (const [key, values] of Object.entries(columnarData)) {
          if (key !== 'id') row.fields[key] = values[i];
        }
        rows.push(row);
      }
      return rows;
    }

    function formatPhoneNumber(phone) {
      const cleaned = ('' + phone).replace(/\D/g, '');
      if (cleaned.length === 10) return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
      return phone || '';
    }

    function throttle(fn, ms){
      let t, lastCall = 0;
      return (...args) => {
        const now = Date.now();
        const remaining = ms - (now - lastCall);
        if (remaining <= 0) {
          lastCall = now;
          fn.apply(null, args);
        } else {
          clearTimeout(t);
          t = setTimeout(() => { lastCall = Date.now(); fn.apply(null, args); }, remaining);
        }
      }
    }

    function toArray(v){ return Array.isArray(v) ? v : (v == null ? [] : [v]); }

    // Global state
    let owners = [];
    let properties = [];
    let ownerMap = {};
    let propertyFeatures = [];
    let originalData = [];
    let visibleProperties = [];
    let isDetailViewActive = false;
    let isSidebarOpen = false;
    let isMobile = window.innerWidth <= 768;

    let amap = null;
    let markersLayer = null;
    const markerIndex = new Map();

    // Classification icon mapping and color helper
    const classifyIcons = {
      "Not Interested/DNC": new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
      "IPA": new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
      "Eric": new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
      "Broker/Eh": new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
      "Never": new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
      "Call Relationship": new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
      "Contact": new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]}),
      "Call Again": new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]})
    };
    const defaultIcon = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]});

    const classificationColorMap = {
      "Not Interested/DNC":"#e83f3d",
      "IPA":"#b158f0",
      "Eric":"#ff9f40",
      "Broker/Eh":"#9fa0a5",
      "Never":"#36a2eb",
      "Call Relationship":"#ffcd56",
      "Contact":"#61e158",
      "Call Again":"#f0bd45"
    };

    function getIconForClassification(key) {
      if (!key) return defaultIcon;
      const found = Object.keys(classifyIcons).find(k => k.toLowerCase() === String(key).toLowerCase());
      if (found) return classifyIcons[found];
      return defaultIcon;
    }

    function getColorForClassification(key){
      if (!key) return '#4a6fa5';
      if (/^#([0-9A-F]{3}){1,2}$/i.test(key)) return key;
      const entry = Object.keys(classificationColorMap).find(k => k.toLowerCase() === String(key).toLowerCase());
      return entry ? classificationColorMap[entry] : '#4a6fa5';
    }

    function getOwnerById(id){ return (id==null || id==='') ? null : (ownerMap[id] || null); }

    // Data from Grist
    async function fetchGristData(){
      try {
        await grist.ready();
        let tables = [];
        try { tables = await grist.docApi.listTables(); } catch(e){ tables=[{tableId:'Owners_'},{tableId:'Properties_'}]; }
        let ownersTable='Owners_', propertiesTable='Properties_';
        if (Array.isArray(tables)) {
          const o = tables.find(t => t && t.tableId && (t.tableId.includes('Owners') || t.tableId === 'Owners_'));
          const p = tables.find(t => t && t.tableId && (t.tableId.includes('Properties') || t.tableId === 'Properties_'));
          ownersTable = o ? o.tableId : ownersTable;
          propertiesTable = p ? p.tableId : propertiesTable;
        }

        const [ownersCol, propsCol] = await Promise.all([
          grist.docApi.fetchTable(ownersTable).catch(()=>null),
          grist.docApi.fetchTable(propertiesTable).catch(()=>null)
        ]);
        if (!ownersCol || !propsCol) throw new Error('Could not access required tables. Please check table configuration.');

        owners = columnarToRowFormat(ownersCol);
        properties = columnarToRowFormat(propsCol);
        ownerMap = {};
        owners.forEach(o => ownerMap[o.id]=o);

        propertyFeatures = properties.map(p => {
          const f = p.fields || {};
          let ownerClassifyColor = '';
          let primaryOwnerName = f.PrimaryOwner || 'Unknown';

          try{
            const validIds = toArray(f.Name).filter(id => id!=null && id!=='');
            if (validIds.length){
              const owner = getOwnerById(validIds[0]);
              if (owner && owner.fields){
                const cc = owner.fields.Classify_Color;
                if (cc) ownerClassifyColor = Array.isArray(cc) ? cc[0] : cc;
                primaryOwnerName = owner.fields.Owner_Full_Name || primaryOwnerName;
              }
            } else if (f.PrimaryOwner) {
              const owner = Object.values(ownerMap).find(o => o?.fields && (o.fields.Name===f.PrimaryOwner || o.fields.Owner_Full_Name===f.PrimaryOwner));
              if (owner){
                const cc = owner.fields.Classify_Color;
                if (cc) ownerClassifyColor = Array.isArray(cc) ? cc[0] : cc;
                primaryOwnerName = owner.fields.Owner_Full_Name || primaryOwnerName;
              }
            }
          }catch(e){}

          const lng = parseFloat(f.Longitude);
          const lat = parseFloat(f.Latitude);

          return {
            type:'Feature',
            geometry:{ type:'Point', coordinates:[lng, lat] },
            properties:{
              ...f,
              id:p.id,
              PrimaryOwner: primaryOwnerName,
              Name_Classify_Color: ownerClassifyColor
            }
          }
        }).filter(feat => {
          const c = feat.geometry?.coordinates || [];
          return Number.isFinite(c[0]) && Number.isFinite(c[1]);
        });

        originalData = propertyFeatures.slice();
        return true;
      } catch (error) {
        const loadingText = document.getElementById('loading-text');
        if (loadingText) loadingText.innerHTML = `<div style="color:#e53935; font-weight:700; text-align:center; padding:10px;">${error.message || 'Error loading map data.'}</div>`;
        return false;
      }
    }

    // Popup content
    function createPopupContent(props){
      const propertyId = props.Property_Id || props["Property Id"] || props.id;
      const displayName = props.PrimaryOwner || props.Name || "Unnamed Property";
      const imgSrc = props.Pop_up_IMG || '';
      const hasImage = !!(imgSrc && String(imgSrc).trim());
      const address = props.Address_Concatenate || '';
      return `
        <div class="card">
          ${hasImage ? `<img src="${imgSrc}" alt="${displayName}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=&quot;width:100%;height:100%;display:grid;place-items:center;background:#e5e7eb;color:#64748b;font-weight:700&quot;>No Image</div>'">`
          : `<div style="width:100%;height:100%;display:grid;place-items:center;background:#e5e7eb;color:#64748b;font-weight:700">No Image</div>`}
          <div class="card-content">
            <div class="title">${displayName}</div>
            <div class="location" onclick="if(window.openPropertySidebar){window.openPropertySidebar('${propertyId}')}">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 11.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 8.5 12 8.5s2.5 1.12 2.5 2.5S13.38 13.5 12 13.5z"/></svg>
              ${address ? address : 'View details'}
            </div>
          </div>
        </div>
      `;
    }

    // Map + markers
    function updateMap(data){
      if (!amap || !markersLayer) return;
      markerIndex.clear();
      markersLayer.clearLayers();

      data.forEach(feature => {
        const [lng, lat] = feature.geometry.coordinates;
        const props = feature.properties;
        const marker = L.marker([lat, lng], {
          icon: getIconForClassification(props.Name_Classify_Color),
          propertyId: props.id,
          classifyValue: props.Name_Classify_Color || ''
        }).bindPopup(createPopupContent(props));

        marker.on('click', () => { try{ selectRow(props.id); }catch(e){} });

        markersLayer.addLayer(marker);
        markerIndex.set(String(props.id), marker);
      });

      if (data.length > 0) {
        const bounds = L.latLngBounds(data.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]));
        amap.fitBounds(bounds, { padding:[50,50] });
      }
    }

    function buildTypePillHTML(typeValue){
      const color = getColorForClassification(typeValue);
      const bg = color + '20'; // alpha
      const border = color + '55';
      return `<span class="property-type" style="background:${bg}; border:1px solid ${border}; color:#111">${typeValue || 'Unclassified'}</span>`;
    }

    // Sidebar: visible within bounds
    function updateSidebar(){
      if (!amap || !Array.isArray(originalData)) return;
      const bounds = amap.getBounds();
      visibleProperties = originalData.filter(f => {
        const [lng, lat] = f.geometry.coordinates;
        return bounds.contains([lat, lng]);
      });

      const countEl = document.getElementById('propertyCount');
      if (countEl) countEl.textContent = String(visibleProperties.length);

      const listEl = document.getElementById('property-list');
      if (!listEl) return;

      listEl.innerHTML = visibleProperties.map(feature => {
        const p = feature.properties;
        const img = p.Pop_up_IMG || '';
        const hasImg = !!(img && String(img).trim());
        const name = p.PrimaryOwner || 'Unknown Owner';
        const pid = p.Property_Id || 'N/A';
        const addr = p.Address_Concatenate || 'No Address';
        const type = p.Name_Classify_Color || 'Unclassified';
        return `
          <div class="property-item" data-id="${p.id}" tabindex="0" aria-label="Property ${name}">
            <div class="property-thumbnail">
              ${hasImg ? `<img src="${img}" alt="${name}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<span>No Image</span>';">` : '<span>No Image</span>'}
            </div>
            <div class="property-info">
              <h4 title="${name}">${name}</h4>
              ${buildTypePillHTML(type)}
              <div class="property-address" title="${addr}">${addr}</div>
              <div class="property-id">ID: ${pid}</div>
            </div>
          </div>
        `;
      }).join('');

      listEl.querySelectorAll('.property-item').forEach(item => {
        item.addEventListener('click', () => {
          const propertyId = item.dataset.id;
          focusMarker(propertyId);
          showPropertyDetails(propertyId);
        });
        item.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const propertyId = item.dataset.id;
            focusMarker(propertyId);
            showPropertyDetails(propertyId);
          }
        });
      });
    }

    function filterSidebar(query, exact=false){
      const listEl = document.getElementById('property-list');
      if (!listEl) return;
      const source = visibleProperties || [];
      const q = (query||'').toLowerCase();

      const filtered = q ? source.filter(f => {
        const p = f.properties;
        const text = [p.PrimaryOwner, p.Property_Id, p.Address_Concatenate, p.Parcel].filter(Boolean).join(' ').toLowerCase();
        return exact ? (text === q) : text.includes(q);
      }) : source;

      listEl.innerHTML = filtered.map(feature => {
        const p = feature.properties;
        const img = p.Pop_up_IMG || '';
        const hasImg = !!(img && String(img).trim());
        const name = p.PrimaryOwner || 'Unknown Owner';
        const pid = p.Property_Id || 'N/A';
        const addr = p.Address_Concatenate || 'No Address';
        const type = p.Name_Classify_Color || 'Unclassified';
        return `
          <div class="property-item" data-id="${p.id}" tabindex="0" aria-label="Property ${name}">
            <div class="property-thumbnail">
              ${hasImg ? `<img src="${img}" alt="${name}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<span>No Image</span>';">` : '<span>No Image</span>'}
            </div>
            <div class="property-info">
              <h4 title="${name}">${name}</h4>
              ${buildTypePillHTML(type)}
              <div class="property-address" title="${addr}">${addr}</div>
              <div class="property-id">ID: ${pid}</div>
            </div>
          </div>
        `;
      }).join('');

      listEl.querySelectorAll('.property-item').forEach(item => {
        item.addEventListener('click', () => {
          const propertyId = item.dataset.id;
          focusMarker(propertyId);
          showPropertyDetails(propertyId);
        });
      });
    }

    function focusMarker(propertyId){
      const marker = markerIndex.get(String(propertyId));
      if (marker && amap) {
        const latLng = marker.getLatLng();
        amap.setView(latLng, Math.max(amap.getZoom(), 14), { animate:true });
        marker.openPopup();
        selectRow(propertyId);
      }
    }

    function showPropertyDetails(propertyId){
      const property = originalData.find(f => String(f.properties.id) === String(propertyId));
      if (!property) return;
      const props = property.properties;

      let owner = null;
      try{
        const validIds = toArray(props.Name).filter(id => id!=null && id!=='');
        if (validIds.length) owner = getOwnerById(validIds[0]);
        else if (props.PrimaryOwner) {
          owner = Object.values(ownerMap).find(o => o?.fields && (o.fields.Name===props.PrimaryOwner || o.fields.Owner_Full_Name===props.PrimaryOwner)) || null;
        }
      }catch(e){ owner = null; }

      const panel = document.getElementById('property-details');
      const list = document.getElementById('property-list');
      const detailsContent = document.getElementById('details-content');

      const imgSrc = props.Pop_up_IMG || '';
      const hasImage = !!(imgSrc && String(imgSrc).trim());

      if (detailsContent) {
        detailsContent.innerHTML = `
          <div class="details-inner-container" style="padding: 10px 12px;">
            <div class="details-content-row" style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
              <div class="details-view-image" style="width:70px;height:52px">
                ${hasImage ? `<img src="${imgSrc}" alt="Property photo" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=&quot;font-size:11px;color:#64748b&quot;>No Image</div>'">`
                : '<div style="font-size:11px;color:#64748b">No Image</div>'}
              </div>
              <div class="details-view-info" style="flex:1; min-width:0;">
                <h3 style="font-size:16px; margin:0 0 4px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${props.PrimaryOwner || 'Unknown'}</h3>
                <div class="details-view-type">${props.Name_Classify_Color || 'Unclassified'}</div>
                <div class="details-view-address" title="${props.Address_Concatenate || ''}">${props.Address_Concatenate || 'No address'}</div>
                <div class="details-view-ids"><span>ID: ${props.Property_Id || 'N/A'}</span><span>Parcel: ${props.Parcel || 'N/A'}</span></div>
              </div>
            </div>

            <div class="phone-section">
              <h4>Phone Numbers</h4>
              <div id="phone-list" style="padding:8px 10px">
                ${generatePhoneRows(owner)}
              </div>
            </div>

            <div style="display:flex; gap:8px; margin-top:10px;">
              <button class="back-btn" id="back-to-list" style="border:1px solid var(--border); background:#fff; border-radius:8px; padding:8px 10px; cursor:pointer">← Back</button>
              <button class="back-btn" id="zoom-to-marker" style="border:1px solid var(--border); background:#fff; border-radius:8px; padding:8px 10px; cursor:pointer">Zoom to marker</button>
            </div>
          </div>
        `;

        const backBtn = detailsContent.querySelector('#back-to-list');
        const zoomBtn = detailsContent.querySelector('#zoom-to-marker');
        backBtn?.addEventListener('click', () => {
          panel.classList.remove('active');
          list.style.display = 'block';
          isDetailViewActive = false;
        });
        zoomBtn?.addEventListener('click', () => focusMarker(propertyId));
      }

      list.style.display = 'none';
      panel.classList.add('active');
      isDetailViewActive = true;
    }

    function generatePhoneRows(owner){
      if (!owner?.fields) return '<div class="phone-item" style="justify-content:center">No phone numbers available</div>';
      const phoneFields = [
        { key:'Phone', note:'Phone_1_Notes' },
        { key:'Phone_2', note:'Phone_2_Notes' },
        { key:'Phone_3', note:'Phone_3_Notes' },
        { key:'Phone_4', note:'Phone_4_Notes' }
      ];
      let html = '', has = false;
      for (const {key, note} of phoneFields){
        const raw = owner.fields[key];
        if (raw==null) continue;
        const phone = String(raw).trim();
        if (!phone || phone==='N/A') continue;
        has = true;
        const notes = owner.fields[note] || '';
        const digits = phone.replace(/\D/g,'');
        html += `
          <div class="phone-item">
            <div class="phone-info">
              <div class="phone-number">${formatPhoneNumber(phone)}</div>
              ${notes ? `<div class="phone-status">${notes}</div>` : ''}
            </div>
            <div class="phone-actions">
              <a class="action-btn" href="sip:${digits}" title="Call via SIP">&#128224;</a>
              <a class="action-btn" href="tel:+1${digits}" title="Call via phone">&#128222;</a>
            </div>
          </div>
        `;
      }
      return has ? html : '<div class="phone-item" style="justify-content:center">No phone numbers available</div>';
    }

    function selectRow(rowId){
      if (!rowId) return;
      try { grist.setCursorPos({ rowId }); } catch(e){}
    }

    function initializeMap(){
      const el = document.getElementById('map');
      if (!el) return;

      if (amap) {
        try { amap.remove(); } catch(e){}
        amap = null;
      }

      amap = L.map('map', { center:[43.8041, -120.5542], zoom:7, zoomControl:true });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'&copy; OpenStreetMap contributors', maxZoom:19
      }).addTo(amap);

      // Marker cluster, return DivIcon (fix)
      markersLayer = L.markerClusterGroup({
        disableClusteringAtZoom: 10,
        maxClusterRadius: 80,
        spiderfyOnMaxZoom: true,
        spiderfyDistanceMultiplier: 1.5,
        zoomToBoundsOnClick: true,
        chunkedLoading: true,
        showCoverageOnHover: true,
        iconCreateFunction: function(cluster){
          try{
            const count = cluster.getChildCount();
            const markers = cluster.getAllChildMarkers();
            const counts = {};
            for (const m of markers){
              const k = (m.options.classifyValue || '').trim();
              if (!k) continue;
              counts[k] = (counts[k] || 0) + 1;
            }
            const top = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '';
            const sizeClass = count>=100 ? 'marker-cluster-large' : (count>=10 ? 'marker-cluster-medium' : 'marker-cluster-small');
            const cls = top ? ` marker-cluster-${top.replace(/[^a-z0-9]+/gi,'_')}` : '';
            return new L.DivIcon({ html:`<div><span>${count}</span></div>`, className:`marker-cluster ${sizeClass}${cls}`, iconSize:new L.Point(40,40) });
          }catch(e){
            return new L.DivIcon({ html:`<div><span>${cluster.getChildCount()}</span></div>`, className:`marker-cluster marker-cluster-small`, iconSize:new L.Point(40,40) });
          }
        }
      });
      amap.addLayer(markersLayer);

      // GeoSearch control
      try{
        const provider = new window.GeoSearch.OpenStreetMapProvider();
        const searchControl = new window.GeoSearch.GeoSearchControl({
          provider,
          style: 'bar',
          searchLabel: 'Search places...',
          autoClose: true,
          retainZoomLevel: false,
          animateZoom: true,
          position: 'topright',
        });
        amap.addControl(searchControl);
      }catch(e){}

      // Fit-all control
      const FitControl = L.Control.extend({
        options:{position:'topright'},
        onAdd: function(){
          const btn = L.DomUtil.create('button');
          btn.title = 'Fit all markers';
          btn.setAttribute('aria-label','Fit all markers');
          btn.style.cssText='margin:8px; padding:8px 10px; border:1px solid #e1e5e9; background:#fff; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,.08); cursor:pointer';
          btn.innerHTML='Fit';
          L.DomEvent.disableClickPropagation(btn);
          btn.addEventListener('click', () => {
            const layers = markersLayer.getLayers();
            if (!layers.length) return;
            const bounds = L.latLngBounds(layers.map(m => m.getLatLng()));
            amap.fitBounds(bounds, { padding:[50,50] });
          });
          return btn;
        }
      });
      amap.addControl(new FitControl());

      // Locate control
      const LocateControl = L.Control.extend({
        options:{position:'topright'},
        onAdd: function(){
          const btn = L.DomUtil.create('button');
          btn.title = 'Locate me';
          btn.setAttribute('aria-label','Locate me');
          btn.style.cssText='margin:8px 8px 0; padding:8px 10px; border:1px solid #e1e5e9; background:#fff; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,.08); cursor:pointer';
          btn.innerHTML='Locate';
          L.DomEvent.disableClickPropagation(btn);
          let userLayer = null;
          btn.addEventListener('click', () => {
            amap.locate({ setView:true, maxZoom:15 });
          });
          amap.on('locationfound', (e) => {
            if (userLayer) amap.removeLayer(userLayer);
            const circle = L.circle(e.latlng, { radius: e.accuracy, color:'#2563eb', fillColor:'#60a5fa', fillOpacity:0.2 });
            const marker = L.circleMarker(e.latlng, { radius:6, color:'#1d4ed8', fillColor:'#3b82f6', fillOpacity:1, weight:2 });
            userLayer = L.layerGroup([circle, marker]).addTo(amap);
          });
          amap.on('locationerror', () => {});
          return btn;
        }
      });
      amap.addControl(new LocateControl());

      const throttledUpdateSidebar = throttle(updateSidebar, 300);
      amap.on('moveend', throttledUpdateSidebar);
      amap.on('zoomend', throttledUpdateSidebar);
    }

    // Sidebar toggling
    function toggleSidebar(){
      const sidebar = document.getElementById('sidebar');
      const map = document.getElementById('map');
      const overlay = document.getElementById('overlay');
      const btn = document.getElementById('sidebarToggle');

      isSidebarOpen = !isSidebarOpen;
      sidebar.classList.toggle('open', isSidebarOpen);
      map.classList.toggle('sidebar-open', isSidebarOpen);
      overlay.classList.toggle('active', isSidebarOpen);
      btn.classList.toggle('active', isSidebarOpen);
      sidebar.setAttribute('aria-hidden', isSidebarOpen ? 'false' : 'true');

      setTimeout(() => { try{ amap.invalidateSize(); }catch(e){} updateSidebar(); }, 360);
    }
    function closeSidebarPanel(){
      const sidebar = document.getElementById('sidebar');
      const map = document.getElementById('map');
      const overlay = document.getElementById('overlay');
      const btn = document.getElementById('sidebarToggle');
      isSidebarOpen = false;
      sidebar.classList.remove('open');
      map.classList.remove('sidebar-open');
      overlay.classList.remove('active');
      btn.classList.remove('active');
      sidebar.setAttribute('aria-hidden','true');
      setTimeout(()=>{ try{ amap.invalidateSize(); }catch(e){} }, 360);
    }
    function updateSidebarLayout(){
      const map = document.getElementById('map');
      if (isMobile) map.classList.remove('sidebar-open');
      else if (isSidebarOpen) map.classList.add('sidebar-open');
      try{ amap.invalidateSize(); }catch(e){}
    }

    window.openPropertySidebar = function(propertyId){
      if (!isSidebarOpen) toggleSidebar();
      setTimeout(()=>{ showPropertyDetails(propertyId); focusMarker(propertyId); }, 280);
    };

    // Init
    function initializeApp(){
      const loading = document.getElementById('loading-indicator');
      loading.style.display='flex';

      try{ initializeMap(); }catch(e){}

      fetchGristData().then(ok => {
        loading.style.display='none';
        if (ok && amap && propertyFeatures) {
          try{
            updateMap(propertyFeatures);
            updateSidebar();
          }catch(e){}
        }

        // UI events
        document.getElementById('sidebarToggle')?.addEventListener('click', toggleSidebar);
        document.getElementById('closeSidebar')?.addEventListener('click', closeSidebarPanel);
        document.getElementById('overlay')?.addEventListener('click', closeSidebarPanel);
        document.getElementById('close-details')?.addEventListener('click', () => {
          document.getElementById('property-details').classList.remove('active');
          document.getElementById('property-list').style.display = 'block';
          isDetailViewActive = false;
        });

        const searchInput = document.getElementById('sidebar-search');
        const clearSearch = document.getElementById('clear-search');
        if (searchInput){
          let t;
          searchInput.addEventListener('input', (e) => {
            const q = e.target.value.trim();
            clearSearch.style.display = q ? 'grid' : 'none';
            clearTimeout(t);
            t = setTimeout(() => filterSidebar(q), 220);
          });
          searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') filterSidebar(searchInput.value, true);
          });
        }
        clearSearch?.addEventListener('click', () => {
          searchInput.value = '';
          clearSearch.style.display = 'none';
          filterSidebar('');
        });

        window.addEventListener('resize', () => {
          const wasMobile = isMobile;
          isMobile = window.innerWidth <= 768;
          if (wasMobile !== isMobile) updateSidebarLayout();
          if (isMobile && isSidebarOpen) closeSidebarPanel();
        });

        // Optional: track Grist selection to focus marker (best-effort)
        try{
          if (typeof grist?.on === 'function') {
            grist.on('cursorPos', (pos) => {
              if (pos?.rowId) focusMarker(pos.rowId);
            });
          }
        }catch(e){}
      }).catch(() => { loading.style.display='none'; });
    }

    if (typeof grist !== 'undefined') {
      try {
        grist.ready({ requiredAccess:'full', selection:true, allowSelectBy:true })
          .then(initializeApp)
          .catch(() => {
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initializeApp);
            else initializeApp();
          });
      } catch(e){
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initializeApp);
        else initializeApp();
      }
    } else {
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initializeApp);
      else initializeApp();
    }
  </script>
</body>
</html>
